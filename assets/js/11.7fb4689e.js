(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{221:function(t,e,s){"use strict";s.r(e);var a=s(1),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"自己配置并维护一个邮件服务器有什么好处呢？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自己配置并维护一个邮件服务器有什么好处呢？"}},[t._v("#")]),t._v(" 自己配置并维护一个邮件服务器有什么好处呢？")]),t._v(" "),s("ol",[s("li",[t._v("不必再用 qq, 163 之类看上去比较 lowbi 的邮箱。")]),t._v(" "),s("li",[t._v("不必再用 gmail 之类收个邮件还要翻墙的邮箱。")]),t._v(" "),s("li",[t._v("精选的应用账号绑定到自己邮件服务器的邮箱，其他的绑定到 lowbi 邮箱，省的垃圾邮件太多。")]),t._v(" "),s("li",[t._v("随意定ID，各种高大上。")])]),t._v(" "),s("p",[t._v("说了那么多，总之还是为了装x。")]),t._v(" "),s("p",[t._v("这里机器配置大部分都原搬 "),s("a",{attrs:{href:"https://www.fancycoding.com/centos7-mail-server-with-dovecot-postfix-ssl/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.fancycoding.com/centos7-mail-server-with-dovecot-postfix-ssl/"),s("OutboundLink")],1),t._v(" 这篇文章，向作者表示感谢。")]),t._v(" "),s("h2",{attrs:{id:"准备工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[t._v("#")]),t._v(" 准备工作")]),t._v(" "),s("p",[t._v("首先你需要有这些个东西")]),t._v(" "),s("ol",[s("li",[t._v("自己的机器（VPS）。")]),t._v(" "),s("li",[t._v("一级域名，然后再去解析个 "),s("code",[t._v("mail.domain.com")]),t._v(" 的二级域名（A记录）。")]),t._v(" "),s("li",[t._v("二级域名去配置下 SSL 证书， 可以用到这个工具："),s("a",{attrs:{href:"https://github.com/Neilpang/acme.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("Neilpang / acme.sh"),s("OutboundLink")],1),t._v("。在最后会执行这个命令")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('acme.sh  --installcert  -d  mail.timehub.cc   \\\n        --keypath   /etc/nginx/keys/mail.timehub.key \\ # 域名证书私钥\n        --fullchainpath /etc/nginx/keys/mail.timehub.crt \\  # 公钥\n        --certpath /etc/nginx/keys/mail.timehub.pem \\ # CA证书\n        --reloadcmd  "service nginx restart"\n')])])]),s("p",[t._v("记住这三个文件的路径。")]),t._v(" "),s("h2",{attrs:{id:"dns-解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dns-解析"}},[t._v("#")]),t._v(" DNS 解析")]),t._v(" "),s("p",[t._v("（"),s("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2016/06/dns.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("DNS 解析的基础知识"),s("OutboundLink")],1),t._v("）")]),t._v(" "),s("p",[t._v("去你的域名提供商那的解析表单，做如下操作：")]),t._v(" "),s("ol",[s("li",[t._v("为主域名添加一条 MX 记录，记录值为 "),s("code",[t._v("mail.domain.com")]),t._v("，优先级为 1 即可。")]),t._v(" "),s("li",[t._v("为主域名添加一条 TXT 记录，该记录值为 "),s("a",{attrs:{href:"http://www.openspf.org/SPF_Record_Syntax",target:"_blank",rel:"noopener noreferrer"}},[t._v("SPF"),s("OutboundLink")],1),t._v(" 。")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("v=spf1 a mx ~all // 指出除了解析的 A 记录 和 MX 记录之外的域发送的邮件都是伪造的\n")])])]),s("p",[t._v("解析个一阵，使用 dig 命令查看是否成功：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ dig MX mail.timehub.cc\n\n; <<>> DiG 9.8.3-P1 <<>> MX mail.timehub.cc\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45640\n;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;mail.timehub.cc.\t\tIN\tMX\n\n;; AUTHORITY SECTION:\ntimehub.cc.\t\t3496\tIN\tSOA\tns19.xincache.com. hostmaster.xinnetdns.com. 2002042718 3600 900 720000 3600\n")])])]),s("h2",{attrs:{id:"安装-postfix（发送电子邮件服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-postfix（发送电子邮件服务器"}},[t._v("#")]),t._v(" 安装 Postfix（发送电子邮件服务器)")]),t._v(" "),s("p",[t._v("安装 "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Postfix_(software)"}},[t._v("Postfix")]),t._v(" 并删除原先的 sendMail：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("yum -y install postfix\nyum remove sendmail\n")])])]),s("p",[t._v("然后进行基本配置：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ vi /etc/postfix/main.cf\n\nmyhostname = mail.timehub.cc\nmydomain = timehub.cc\nmyorigin = mail.timehub.cc\nmynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128, 192.168.1.0/24\ninet_interfaces = all\nmydestination = $myhostname, localhost.$mydomain, localhost, $mydomain\nsmtpd_sasl_auth_enable = yes\nsmtpd_sasl_type = cyrus\nsmtpd_sasl_security_options = noanonymous\nbroken_sasl_auth_clients = yes\nsmtpd_sasl_authenticated_header = yes\nsmtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination\nsmtpd_tls_auth_only = no\nsmtp_use_tls = yes\nsmtpd_use_tls = yes\nsmtp_tls_note_starttls_offer = yes\nsmtpd_tls_key_file = /etc/nginx/keys/mail.timehub.key\nsmtpd_tls_cert_file = /etc/nginx/keys/mail.timehub.crt\nsmtpd_tls_CAfile = /etc/nginx/keys/mail.timehub.pem\nsmtpd_tls_received_header = yes\nsmtpd_tls_session_cache_timeout = 3600s\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ vi /etc/postfix/master.cf\n\nsubmission inet n       -       -       -       -       smtpd\n  -o syslog_name=postfix/submission\n  -o smtpd_tls_wrappermode=no\n  -o smtpd_tls_security_level=encrypt\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject\n  -o milter_macro_daemon_name=ORIGINATING\n  -o smtpd_sasl_type=dovecot\n  -o smtpd_sasl_path=private/auth\n")])])]),s("h2",{attrs:{id:"安装-dovecot（接收-imap-和-pop3-邮件服务器）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-dovecot（接收-imap-和-pop3-邮件服务器）"}},[t._v("#")]),t._v(" 安装 Dovecot（接收 IMAP 和 POP3 邮件服务器）")]),t._v(" "),s("p",[t._v("安装 "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Dovecot_(software)"}},[t._v("Dovecot")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("yum -y install  dovecot\n")])])]),s("p",[t._v("然后进行基本配置：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ vim /etc/dovecot/dovecot.conf\n\nprotocols = imap pop3\nmail_location = mbox:~/mail:INBOX=/var/mail/%u\npop3_uidl_format = %08Xu%08Xv\n\nservice auth {\n    unix_listener /var/spool/postfix/private/auth {\n    group = postfix\n    mode = 0660\n    user = postfix\n}\n}\n\nssl=required\nssl_cert = </etc/nginx/keys/mail.timehub.crt\nssl_key = </etc/nginx/keys/mail.timehub.key\nssl_ca = </etc/nginx/keys/mail.timehub.pem\n")])])]),s("h2",{attrs:{id:"启动所有服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动所有服务"}},[t._v("#")]),t._v(" 启动所有服务")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ newaliases # 将送给使用者的信都收给 mailing list 处理程序负责分送的工作\n$ service postfix restart\n$ service dovecot restart\n")])])]),s("p",[t._v("查看 log：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ cat /var/log/maillog\n\nFeb 21 15:12:00 fancycoding dovecot: master: Dovecot v2.2.10 starting up for imap, pop3 (core dumps disabled)\n")])])]),s("p",[t._v("如果一直没有 log 生成，试着重启下系统日志服务：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ service rsyslog restart\n")])])]),s("h2",{attrs:{id:"连接邮件客户端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#连接邮件客户端"}},[t._v("#")]),t._v(" 连接邮件客户端")]),t._v(" "),s("p",[t._v("首先创建用户：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("useradd -s /sbin/nologin admin\npasswd admin\n")])])]),s("p",[t._v("打开邮件客户端，新建账户 "),s("code",[t._v("admin@domain.com")]),t._v("，收发邮件服务器填写 "),s("code",[t._v("mail.domain.com")]),t._v("，顺利的话就可以收发邮件了。")]),t._v(" "),s("h2",{attrs:{id:"nodejs-下发送邮件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-下发送邮件"}},[t._v("#")]),t._v(" NodeJS 下发送邮件")]),t._v(" "),s("p",[t._v("使用到 "),s("a",{attrs:{href:"https://github.com/nodemailer/nodemailer",target:"_blank",rel:"noopener noreferrer"}},[t._v("nodemailer"),s("OutboundLink")],1),t._v("，首先从 npm 安装：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ npm install nodemailer --save\n")])])]),s("p",[t._v("在代码中使用：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("import nodemailer from 'nodemailer';\n\nconst mailTransport = nodemailer.createTransport({\n  host: 'mail.timehub.cc',\n  secureConnection: true, // use SSL\n  auth: {\n    user: 'lightpress',\n    pass: 'pass'\n  }\n});\n\nexport default {\n  send(options) {\n    var {to = [], subject = '', text = '', html = ''} = options;\n    return new Promise((reslove, reject) => {\n      mailTransport.sendMail({\n        from: '\"Lightpress\" <lightpress@timehub.cc>',\n        to: to.join(','),\n        subject, text, html\n      }, (err, msg) => {\n        if (err) reject(err);\n        else reslove(msg);\n      });\n    });\n  }\n};\n")])])]),s("p",[t._v("正常的话即可发出邮件。")])])}),[],!1,null,null,null);e.default=n.exports}}]);